name: test Build stable kernel package

on:
  workflow_dispatch:
    inputs:
      release:
        type: choice
        description: Release type
        options:
          - none
          - pre-release
          - release

env:
  HOME: /home/runner/work
  KERNEL_STABLE_VER: 6.8.7
  PKGVER: 2

jobs:
  build:
    name: build kernel deb 
    runs-on: ubuntu-latest
    steps:
     - name : prepare environment 
       run: |
            sudo apt-get update \
            && sudo apt-get install -y build-essential \
                 bc kmod cpio flex libncurses-dev \
                 libelf-dev libssl-dev dwarves bison \
                 gawk openssl libssl-dev dkms libudev-dev \
                 libpci-dev libiberty-dev autoconf \
                 debhelper lz4
                 
     - name: Checkout main repo
       uses: actions/checkout@v4
       with:
        submodules: true

     - name: Download linux kernel source
       run: |
            wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_STABLE_VER }}.tar.xz \
            && tar xvf linux-${{ env.KERNEL_STABLE_VER }}.tar.xz

     - name: Apply patches
       env:
        working-directory: linux-${{ env.KERNEL_STABLE_VER }}
       run: |
             patch -Np1 -i ../patches/kernel_compiler_patch/more-uarches-for-kernel-6.8-rc4+.patch
             for i in ../patches/xanmod/linux-6.8.y-xanmod/net/netfilter/*FLOWOFFLOAD*.patch \
                      ../patches/xanmod/linux-6.8.y-xanmod/net/tcp/bbr3/*.patch \
                      ../patches/xanmod/linux-6.8.y-xanmod/net/tcp/cloudflare/*.patch; do 
                     patch -Np1 -i ${i}
             done
             for i in $(grep '^Patch' ../patches/clearlinux/linux.spec |\
                grep -Ev '^Patch0132|^Patch0118|^Patch0113|^Patch0138|^Patch0139|^Patch0109|^Patch0147' | sed -n 's/.*: //p'); do
              patch -Np1 -i "../patches/clearlinux/${i}"
             done
             patch -Np1 -i ../patches/cachy/6.8/0001-aes-xts.patch
             patch -Np1 -i ../patches/cachy/6.8/0007-ksm.patch
             patch -Np1 -i ../patches/cachy/6.8/0009-zstd.patch
             patch -Np1 -i ../patches/tcp-brutal/0001-net-tcp_brutal-make-it-as-a-built-in-kernel-module.patch
             patch -Np1 -i ../patches/tcp-brutal/0002-net-tcp_brutal-use-div_u64-to-let-it-build-on-32-bit.patch
             patch -Np1 -i ../patches/bcm-fullcone/0001-netfilter-nat-add-brcm-fullcone-support.patch
             patch -Np1 -i ../patches/bcm-fullcone/0002-netfilter-nat-add-brcm-fullcone-nft-support.patch

    
